{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
{{ form.media }}

<style>
  .document-form {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      background: #f9f9f9;
  }
</style>

<h1 class="mb-4">
  {% if object %}
    <a class="btn btn-sm btn-info" href="{% url 'cases:client_update' object.client.pk %}">
      <i class="fas fa-edit"></i> تعديل
    </a>
  {% else %} 
    إضافة 
  {% endif %} 
  القضايا
</h1>

<form method="post" action="{% if object %}{% url 'cases:case_update' object.pk %}{% else %}{% url 'cases:case_create' %}{% endif %}" enctype="multipart/form-data">
  {% csrf_token %}
  {{ form.non_field_errors }}

  <div class="form-row">
    <div class="form-group col-md-6">
      <label for="{{ form.title.id_for_label }}">العنوان:</label>
      {{ form.title|add_class:"form-control" }}
      {% for error in form.title.errors %}
        <div class="invalid-feedback">{{ error }}</div>
      {% endfor %}
    </div>
    <div class="form-group">
      <label for="{{ form.case_number.id_for_label }}">رقم القضية:</label>
      {{ form.case_number|add_class:"form-control" }}
    </div>
    <div class="form-group">
      <label for="{{ form.court.id_for_label }}">المحكمة:</label>
      {{ form.court|add_class:"form-control" }}
      {% for error in form.court.errors %}
          <div class="invalid-feedback">{{ error }}</div>
      {% endfor %}
    </div>
  

    <div class="form-group col-md-6">
      <label for="{{ form.client.id_for_label }}">العميل:</label>
      {{ form.client|add_class:"form-control" }}
      {% for error in form.client.errors %}
        <div class="invalid-feedback">{{ error }}</div>
      {% endfor %}
    </div>
  </div>

  <div class="form-row">
    <div class="form-group col-md-6">
      <label for="{{ form.lawyer.id_for_label }}">المحامي:</label>
      {{ form.lawyer|add_class:"form-control" }}
      {% for error in form.lawyer.errors %}
        <div class="invalid-feedback">{{ error }}</div>
      {% endfor %}
    </div>

    <div class="form-group col-md-6">
      <label for="{{ form.status.id_for_label }}">الحالة:</label>
      {{ form.status|add_class:"form-control" }}
      {% for error in form.status.errors %}
        <div class="invalid-feedback">{{ error }}</div>
      {% endfor %}
    </div>
  </div>

  <div class="form-group">
    <label for="{{ form.description.id_for_label }}">الوصف:</label>
    {{ form.description|add_class:"form-control" }}
    {% for error in form.description.errors %}
      <div class="invalid-feedback">{{ error }}</div>
    {% endfor %}
  </div>
  

  <div class="form-group">
    <h4>المستندات:</h4>
    {{ formset.management_form }}
    <div id="documents-container">
        {% for form in formset %}
        <div class="document-form">
          {{ form.id }}
          <div class="form-group">
              <label>عنوان المستند:</label>
              {{ form.title|add_class:"form-control" }}
              {{ form.title.errors }}
          </div>
          <div class="form-group">
              <label>الملف:</label>
              {% if form.instance.file %}
                  <div class="mb-2">
                      <a href="{{ form.instance.file.url }}" target="_blank" class="btn btn-sm btn-info">
                          <i class="fas fa-file"></i> الملف الحالي
                      </a>
                      <span class="text-muted">(اترك الحقل فارغاً للحفاظ على الملف الحالي)</span>
                  </div>
              {% endif %}
              {{ form.file|add_class:"form-control-file" }}
              {{ form.file.errors }}
          </div>
          {% if form.instance.pk %}
              <div class="form-check">
                  {{ form.DELETE|add_class:"form-check-input" }}
                  <label class="form-check-label text-danger">حذف</label>
              </div>
          {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Hidden empty template -->
    <div id="empty-form" class="document-form" style="display: none;">
        <div class="form-group">
            <label>عنوان المستند:</label>
            <input type="text" name="documents-__prefix__-title" class="form-control">
        </div>
        <div class="form-group">
            <label>الملف:</label>
            <input type="file" name="documents-__prefix__-file" class="form-control-file">
        </div>
    </div>

    <button type="button" class="btn btn-sm btn-secondary mt-2" id="add-document">
        <i class="fas fa-plus"></i> إضافة مستند آخر
    </button>
  </div>

  <br>
  <button type="submit" class="btn btn-primary">حفظ</button>
  <a class="btn btn-secondary" href="{% url 'cases:case_list' %}">إلغاء</a>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('documents-container');
    const addButton = document.getElementById('add-document');
    const totalForms = document.getElementById('id_documents-TOTAL_FORMS');
    const emptyForm = document.getElementById('empty-form');

    let formCount = container.children.length;

    addButton.addEventListener('click', function(e) {
        e.preventDefault();
        let newForm = emptyForm.cloneNode(true);
        newForm.style.display = 'block';

        const regex = /__prefix__/g;
        newForm.innerHTML = newForm.innerHTML.replace(regex, formCount);
        container.appendChild(newForm);
        
        formCount++;
        totalForms.value = formCount;
    });
});
</script>

{% endblock %}
